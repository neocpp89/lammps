# ------ 3D hopper ------ #

dimension          3
units              lj
atom_style         rheo
boundary           p s p
comm_modify        vel yes
newton off
comm_style          tiled


# ------ Create simulation box ------ #

# variable           sf equal 0.05
variable           sf equal 0.25
variable           n equal 1.0/(${sf}^3)
variable           cut equal 3.0*${sf}

region             box block -1 1 -10 10 -1 1 units box
create_box         2 box
lattice            sc ${n}

region             interior block -1 1 0.0 1 -1 1 units box

create_atoms       1 region interior

group              fluid type 1

# ------ Model parameters ------ #

variable           rho0 equal 1.0
variable           mp equal ${rho0}/${n}
variable           cs equal 10
variable           zeta equal 1
variable           Dr equal 0.1*${cut}*${cs}
variable           dt_max equal 1e-4
variable           g equal 0.0245
variable           fext equal ${g}
variable           eta equal 0.05

mass               * ${mp}
variable           d0 atom (${rho0}*${g}*(20-y)/${cs}/${cs})+${rho0}
set                group all rheo/rho ${rho0}
set                group fluid rheo/rho v_d0

set                group all rheo/status 0

timestep           ${dt_max}

pair_style         rheo/granular ${cut} artificial/visc 1.0
pair_coeff         * *


# ------ Fixes & computes ------ #

# fix                1 fluid addforce 0.0 -${fext} 0.0
# 25 deg tilt
fix                1 fluid addforce 0.0 -0.022204540782397926 0.010354147412647136
fix                2 all balance 1000 1.1 rcb
# Don't mark sticky so it will be frictional (hardcoded)
fix                3 all rheo ${cut} cubic 32 surface/detection coordination 80 10 density ${rho0} ${rho0} boundary/stlfile boundaries_3.stl boundary/stickybitmask 0x00
fix                4 all rheo/viscosity * constant ${eta}
fix                5 all rheo/pressure * linear
fix                6 all rheo/stress mu_s 0.6 mu_2 0.6

compute            1 all rheo/property/atom rho phase surface surface/n/x surface/n/y
compute            mycompute all rheo/property/atom grad/v/xx grad/v/xy grad/v/yx grad/v/yy


# ------ Output & Run ------ #

thermo             10
thermo_style       custom step time ke press

variable           skin equal 0.2*${cut}
neighbor           ${skin} bin
neigh_modify       one 5000

dump               1 all custom 1000 atomDump_mu_wall_25 id type x y z vx vy vz fx fy fz c_1[*] c_6_compute[*] c_mycompute[*]
dump               dmpvtk all vtk 1000 dump/mu_wall_25_dump*.vtk id type x y z vx vy vz fx fy fz

# run                1000
run                1000000
